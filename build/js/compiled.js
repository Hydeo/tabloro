"use strict";function slice(e,t,n){switch(arguments.length){case 0:throw"no args";case 1:return slice(e,0,e.length);case 2:return slice(e,t,e.length);default:for(var o=Math.max(0,n-t),i=new Array(o),r=-1;++r<o;)i[r]=e[t+r];return i}}function random(e,t){if(void 0===t)throw new Error("random end must be defined");var n=Math.floor(Math.random()*(t-e+1));return n+=e}function isFunction(e){var t={};return e&&"[object Function]"===t.toString.call(e)}function maybeFun(e){return isFunction(e)?e():void 0}function maybe(e){return function(t){return t?e(t):!1}}function dynamicInvoke(e){return function(t){return t[e](t)}}function randomFrom(e){var t=random(0,e.length-1);return e[t]}function chance(e,t){random(0,100)<e&&t()}function double(e){return 2*e}function randomDirection(){var e=1===random(0,2)?"+":"-";return e}function numberWithCommas(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function preload(){chatInput=document.getElementById("chatInput"),Assets.preload(game)}function create(){setupStage(),setupTable(),setupTiles(),Controls.add(),UI.init(),setupPlayers(),Cursor.set(),Video.init()}function setupStage(){var e=document.getElementById("please_wait");e&&e.remove(),game.stage.disableVisibilityChange=!0,game.scale.scaleMode=Phaser.ScaleManager.RESIZE,game.scale.setScreenSize(!0),game.scale.onResize=UI.update;var t=game.canvas;t.id="boardgame",game.canvas.oncontextmenu=function(e){e.preventDefault()},game.physics.startSystem(Phaser.Physics.ARCADE),game.world.setBounds(0,0,World.width,World.height)}function setupTable(){table=game.add.tileSprite(0,0,World.width,World.height,"table")}function addCards(e,t,n){var o=[];return R.forEach(function(e){var i=t.create(100,100,"tile",e);i.defaultFrame=e,n&&n.config.hidden&&T.hide(i),T.scale(.5,i),T.setDefaultTint(15658734,i),R.compose(T.setId,Cursor.reset,T.networkAble,T.stackable,T.rotateable,T.draggable,T.centerAnchor)(i),o.push(i.id),Controls.target=i})(e),Controls.target}function addTokens(e,t,n,o){R.forEach.idx(function(e,i){var r=tokens.create(n+i,o-2*i,e);T.setId(r),T.scale(.6,r),T.setDefaultTint(t,r),R.compose(Cursor.reset,T.networkAble,T.rotateable,T.draggable,T.centerAnchor)(r)})(e)}function setupTiles(){stacks=game.add.group(),redDice=game.add.group(),blueDice=game.add.group(),G.init(game),stack1=S.create({image:"stack1",x:400,y:300,shuffle:!0,hidden:!0}),stack2=S.create({image:"stack2",x:100,y:300,shuffle:!0,hidden:!1}),cards1=game.add.group(),cards1.z=15,cards1.rotateBy=Math.PI/2,addCards(R.concat(R.range(1,38),R.range(40,49)),cards1,stack1);var e=addCards([39],cards1);e.rotation+=Math.PI,e.x=Screen.x/2,e.y=Screen.y/2,tokens=game.add.group(),tokens.z=16,tokens.rotateBy=Math.PI/2,addTokens(R.repeatN("soldier",7),3158816,330,60),addTokens(R.repeatN("soldier",7),3390463,400,60),addTokens(R.repeatN("soldier",7),14496563,470,60),addTokens(R.repeatN("soldier",7),2280482,540,60),addTokens(R.repeatN("soldier",7),16772642,610,60),addTokens(R.repeatN("soldier",7),16777215,680,60),Dice.add(redDice,0,14496563),Dice.add(redDice,1,14496563)}function setupPlayers(){UI.updateNames(),players=game.add.group(),players.z=17,player={cursor:cursorId,name:playerName}}function update(){if(Network.ready!==!1){S.update(),G.update();var e={x:Math.floor(game.input.activePointer.worldX),y:Math.floor(game.input.activePointer.worldY)};if(game.input.keyboard.isDown(Phaser.Keyboard.UP))game.camera.y-=30;else if(game.input.keyboard.isDown(Phaser.Keyboard.DOWN))game.camera.y+=30;else if(game.input.keyboard.isDown(Phaser.Keyboard.LEFT))game.camera.x-=30;else if(game.input.keyboard.isDown(Phaser.Keyboard.RIGHT))game.camera.x+=30;else if(game.input.keyboard.isDown(Phaser.Keyboard.ENTER)&&chatInput.value.length>0){var t=chatInput.value;chatInput.value="",Network.server.chat(t)}game.input.mouse.event&&(game.input.mouse.event.wheelDeltaX&&(game.camera.x-=game.input.mouse.event.wheelDeltaX),game.input.mouse.event.wheelDeltaY&&(game.camera.y-=game.input.mouse.event.wheelDeltaY)),player.lastPosition&&player.lastPosition.x==e.x&&player.lastPosition.y==e.y||(Network.server.moveCursor(e),player.lastPosition=e)}}var Assets={};Assets.preload=function(e){var t=R.range(1,55);R.forEach(function(t){e.load.image("cursor"+t,"/img/cursors/"+t+".png")})(t),e.load.image("table","/assets/table_low.jpg"),e.load.image("stack1","/assets/stack1.png"),e.load.image("stack2","/assets/stack2.png"),e.load.image("save","/assets/save.png"),e.load.image("move","/assets/move.png"),e.load.image("load","/assets/load.png"),e.load.image("rotate","/assets/rotate.png"),e.load.image("soldier","/assets/soldier.png"),e.load.image("farmer","/assets/farmer.png"),e.load.spritesheet("pieces","/assets/pieces.png",64,64,19),e.load.atlasXML("diceWhite","/assets/diceWhite.png","/assets/diceWhite.xml"),e.load.spritesheet("button","/assets/button_sprite_sheet.png",193,71),e.load.atlasJSONHash("tile","/assets/carcassoneSheet.png","/assets/carcassone.json")};var Controls={},cursors;Controls.add=function(){Controls.controls=game.add.group(),Controls.controls.position.set(-100);var e=Controls.controls.create(0,0,"rotate");e.scale.set(.7),T.centerAnchor(e),e.inputEnabled=!0,e.input.useHandCursor=!0,e.events.onInputUp.add(T.onRotate),Cursor.reset(e)},Controls.at=function(e){Controls.controls.visible=!0,Utils.toCorner(Controls.controls,e)},Controls.hide=function(e){e?Controls.target===e&&(Controls.controls.visible=!1):Controls.controls.visible=!1},Controls.cursors=function(){game.input.keyboard.createCursorKeys()};var Cursor={};Cursor.new=function(e){var t=players.create(0,0,"cursor"+e.cursor);return t.name=e.name,t.addChild(game.add.text(40,0,e.name,{font:"26px Arial",fill:"#fff"})),Cursor.set(),t},Cursor.set=function(){game.canvas.setAttribute("style","cursor: url(/img/cursors/"+cursorId+".png), auto;")},Cursor.reset=function(e){return e.events.onInputOut.add(Cursor.set),e};var Dice={};Dice.add=function(e,t,n){n=n||16777215;var o=e.create(800,30+70*t,"diceWhite");return o.animations.add("spin",[0,1,2,3,4,5]),o.play("spin",30),o.animations.currentAnim.setFrame(t,!0),T.draggable(o),o.tint=n,Dice.spinnable(o),Cursor.reset(o),T.setId(o),T.networkAble(o),o},Dice.spin=function(e,t,n){R.forEach.idx(function(e,o){var i=G.findTile(e),r=t[o],a=n[o];i.play("spin",100,!0),setTimeout(function(){i.animations.stop(null,!1),i.frame=a},r-200),game.add.tween(i).to({rotation:r/20},r,Phaser.Easing.Cubic.Out,!0,0,!1)})(e)},Dice.onSpinClicked=function(e){var t=R.pluck("id")(e.parent.children);Network.server.spin(t)},Dice.spinnable=function(e){e.anchor.set(.4),e.events.onInputUp.add(Dice.onSpinClicked,this)};var G={};G.init=function(e){G.button=R.converge(e.add.button,R.always(0),R.always(0),R.always("button"),R.I,R.argN(1),R.always(1),R.always(0),R.always(2)).bind(e.add)},G.addText=R.curryN(2,function(e,t,n,o){o=o||"#ccc";var i=game.add.text(20,20,e,{fontSize:"32px",fill:o});return n&&n(i,t),t.setText=i.setText.bind(i),t.addChild(i),t}),G.updatePositions=[],G.update=function(){R.forEach(function(e){Utils.alignPosition(e.follower,e.target)})(G.updatePositions)},G.addUpdatePosition=function(e){G.updatePositions.push(e)},G.removeUpdatePosition=function(e){G.updatePositions=R.reject(R.propEq("target",e))(G.updatePositions)},G.findTile=function(e){e=Number(e);var t=R.find(R.propEq("id",e))(cards1.children);return t=t||R.find(R.propEq("id",e))(tokens.children),t=t||R.find(R.propEq("id",e))(redDice.children),t?t:{}},G.findStack=function(e){e=Number(e);var t=R.find(R.propEq("id",e))(stacks.children);return t?t:{}};var Network={};Network.ready=!1,Network.isMine=function(e){return Network.myId===e},Network.setup=function(){Network.client=new Eureca.Client,Network.client.ready(function(e){Network.server=e}),Network.client.exports.setId=function(e){Network.myId=e,Network.server.handshake(e,cursorId,playerName,roomName),create(),Network.ready=!0},Network.client.exports.kill=function(e){playerList[e.id]&&(playerList[e.id].kill(),delete playerList[e.id],UI.message(e.name,"left the table..."),UI.updateNames()),Video.killClient(e.id,e.name)},Network.client.exports.spawnPlayer=function(e,t){if(!Network.isMine(e.id)){var n=Cursor.new(e);playerList[e.id]=n,UI.message(e.name,"joined the table!"),UI.updateNames(),Video.newClient(e.id,e.name)}},Network.client.exports.updateCursor=function(e,t){Network.isMine(e.id)||playerList[e.id]&&(playerList[e.id].x=t.x,playerList[e.id].y=t.y)},Network.client.exports.dragTile=function(e,t){if(!Network.isMine(e.id)){var n=G.findTile(t);n.defaultFrame&&T.show(n),Controls.hide(n),G.addUpdatePosition({follower:n,target:playerList[e.id]})}},Network.client.exports.positionTile=function(e,t,n){if(Network.isMine(e.id)){var o=G.findTile(t);Controls.hide(o),R.compose(T.enableInput,T.show)(o),Utils.alignPosRot(o,n),UI.message("Positioning tile",t)}},Network.client.exports.dropTile=function(e,t,n){var o=G.findTile(t);S.removeCardFromStacks(t),Network.isMine(e.id)||(Controls.hide(o),UI.message(e.name,"moved tile",o.id),G.removeUpdatePosition(playerList[e.id]),Utils.alignPosRot(o,n))},Network.client.exports.dragStack=function(e,t){if(!Network.isMine(e.id)){var n=G.findStack(t);n.remoteDragged=!0,G.addUpdatePosition({follower:n,target:playerList[e.id]})}},Network.client.exports.dropStack=function(e,t,n){if(!Network.isMine(e.id)){var o=G.findStack(t);G.removeUpdatePosition(playerList[e.id]),o.remoteDragged=!1,Utils.alignPosRot(o,n),S.tidy(o),UI.message(e.name,"moved stack",t)}},Network.client.exports.positionStack=function(e,t,n){if(Network.isMine(e.id)){var o=G.findStack(t);Utils.alignPosRot(o,n.position),S.updateCards(o,n.cards),S.alignElements(o),UI.message("Positioning stack",t)}},Network.client.exports.updateStackCards=function(e,t,n){G.removeUpdatePosition(playerList[e.id]);var o=G.findStack(t);S.updateCards(o,n)},Network.client.exports.flipStack=function(e,t){var n=G.findStack(t);S.flipCards(n)},Network.client.exports.spin=function(e,t,n,o){Dice.spin(t,n,o)},Network.client.exports.receiveChat=function(e,t){UI.message(e.name,":",t)}};var S={};S.offsetX=1.2,S.offsetY=-1,S.create=function(e){var t=T.centerAnchor(stacks.create(0,0,e.image));t.width=280,t.height=280,t.align=[],t.config=e,T.draggable(t),t.input.useHandCursor=!1,t.events.onInputDown.add(S.onDragStack),t.events.onInputUp.add(S.onDropStack),T.setId(t),t.cards=[],t.position.set(e.x,e.y),G.addText("0",t,Utils.childTo(0,.78),"#3b74aa");var n=R.compose(Cursor.reset,S.align(t),Utils.aboveCorner(t),S.assign(t),T.scale(.4));return e.shuffle&&R.compose(n,G.addText("SHUFFLE"))(UI.handCursor(G.button(S.onShuffleButton,t))),e.hidden||R.compose(n,G.addText("FLIP"))(UI.handCursor(G.button(S.onFlipButton,t))),t},S.align=R.curry(function(e,t){var n=R.last(e.align);return e.align.push(t),n&&(t.x+=n.width*(e.align.length-1)),S.assignRelativePosition(e,t)}),S.assignRelativePosition=function(e,t){return t.relativePosition?t:(t.relativePosition={x:t.x-e.x,y:t.y-e.y},t)},S.assign=R.curry(function(e,t){return t.stack=e,t}),S.onDragStack=function(e){Network.server.stackDragStart(e.id),Controls.hide()},S.onDropStack=function(e){var t=e.position.clone();t.width=e.width,t.height=e.height,Network.server.stackDragStop(e.id,t),S.tidy(e)},S.onShuffleButton=function(){var e=this;Network.server.shuffleStack(e.id)},S.onFlipButton=function(e){var t=e.stack;Network.server.flipStack(t.id)},S.bringToTop=function(e){return e.bringToTop(),e},S.tidy=function(e){var t;return R.forEach.idx(function(n,o){var i=G.findTile(n);i.inputEnabled=!1,Utils.alignPosition(i,S.calculateCardPos(e,o)),e.config.hidden&&T.hide(i),i&&(t=i),S.bringToTop(i)})(e.cards),t&&(t.inputEnabled=!0),t&&UI.handCursor(t),S.alignElements(e),S.updateCounter(e)},S.overlap=R.curry(function(e,t){return game.physics.arcade.overlap(e,t)}),S.flipCards=function(e){R.forEach(function(e){var t=G.findTile(e);0===t._frame.index?T.show(t):T.hide(t)})(e.cards)},S.update=function(){stacks.forEach(function(e){(e.input.isDragged||e.remoteDragged)&&(S.alignElements(e),S.alignStackCards(e))})},S.calculateCardPos=function(e,t){return{x:e.x+S.offsetX*t,y:e.y+S.offsetY*t}},S.alignStackCards=function(e){R.forEach.idx(function(t,n){var o=G.findTile(t);o.inputEnabled=!1,Utils.alignPosition(o,S.calculateCardPos(e,n))})(e.cards)},S.alignElements=function(e){R.forEach(S.moveRelativeTo(e))(e.align)},S.moveRelativeTo=R.curry(function(e,t){return t.relativePosition?(t.x=e.x+t.relativePosition.x,t.y=e.y+t.relativePosition.y,t):t}),S.updateCounter=function(e){return e.setText(e.cards.length),e},S.updateCards=function(e,t){if(e&&t){var n=R.difference(t,e.cards);R.forEach(S.removeCardFromStacks)(n),e.cards=t,n.length?R.forEach(function(t){var n=G.findTile(t),o=game.add.tween(n).to(e.position,200,Phaser.Easing.Cubic.In,!0,0,!1);o.onComplete.add(function(){S.tidy(e)})})(n):S.tidy(e)}},S.removeCardFromStacks=function(e){var e=Number(e);return R.forEach(function(t){t.cards=R.reject(R.eq(e))(t.cards),S.tidy(t)})(stacks.children),e};var T={};T.id=0,T.centerAnchor=function(e){return e.anchor.set(.5),e},T.draggable=function(e){return e.controls=e.controls||game.add.group(),e.inputEnabled=!0,e.input.enableDrag(!1,!0),e.input.useHandCursor=!0,game.physics.arcade.enable(e),e.body.collideWorldBounds=!0,e},T.networkAble=function(e){return e.events.onInputDown.add(T.onStartDrag),e.events.onInputUp.add(T.onStopDrag),e},T.stackable=function(e){return e.stackable=!0,e},T.scale=R.curry(function(e,t){return t.scale.set(e),t}),T.setId=function(e){return e.id=T.id++,e},T.resetRotation=function(e){return e.rotation=0,e},T.rotateable=function(e){return e.rotateable=!0,e.events.onInputDown.add(T.onStartDragRotate),e.events.onInputUp.add(T.onStopDragRotate),e},T.onRotate=function(){var e=Controls.target.parent.rotateBy||Math.PI/2,t=Controls.target.position.clone();t.rotation=Controls.target.rotation+e,Network.server.tileDragStop(Controls.target.id,t),game.add.tween(Controls.target).to({rotation:"+"+e},50,Phaser.Easing.Linear.None,!0,0,!1)},T.defaultTint=function(e){return e.tint=e.defaultTint,e},T.setDefaultTint=function(e,t){return t.defaultTint=t.tint=e,t},T.resetTint=function(e){return e.tint+=3355443,e},T.onStartDrag=function(e){Network.server.tileDragStart(e.id)},T.onStopDrag=function(e){var t=e.position.clone();t.rotation=e.rotation,Network.server.tileDragStop(e.id,t)},T.onStartDragRotate=function(e){Controls.target=e,T.show(e),Controls.hide()},T.onStopDragRotate=function(e){Controls.at(e)},T.enableInput=function(e){return e.inputEnabled=!0,e},T.show=function(e){return e.frame=e.defaultFrame,e},T.hide=function(e){return e.frame=0,e};var UI={};UI.lines=[],UI.init=function(){UI.gameText=game.add.text(0,0,"C A R C A S S O N E",{font:"bold 32px Times",fill:"#ccc"}),UI.nameText=game.add.text(0,0,"----------------\nNAME:"+playerName,{font:"bold 22px Times",fill:"#ccc"}),UI.nameText.align="right",UI.messageText=game.add.text(0,0,"Messages:",{font:"22px Times",fill:"#ccc"}),UI.messageText.align="right",UI.textElements=[UI.gameText,UI.nameText,UI.messageText],UI.update()},UI.update=function(){R.forEach(UI.fixedToCamera(!1))(UI.textElements),UI.gameText.x=UI.nameText.x=UI.messageText.x=game.canvas.width-400,UI.gameText.y=16,UI.nameText.y=46,UI.messageText.y=260,R.forEach(UI.fixedToCamera(!0))(UI.textElements)},UI.fixedToCamera=R.curry(function(e,t){return t.fixedToCamera=e,t}),UI.handCursor=function(e){return e.input.useHandCursor=!0,e},UI.message=function(){var e=R.join(" ",slice(arguments));e=e.match(/.{1,30}/g),UI.lines=R.concat(e,UI.lines),UI.lines.length>15&&UI.lines.pop(),UI.messageText.setText("-> "+R.join("\n")(UI.lines)+"\n...")},UI.setNames=function(e){UI.nameText.setText(R.join("-",new Array(41))+"\nTable: "+roomName+"\n"+R.join("\n")(e))},UI.updateNames=function(){UI.setNames(R.concat(["* "+playerName+" *"],R.pluck("name",R.values(playerList))))};var Utils={humanize:function(e,t,n){return R.align(ifLte,R.interpolate(e,t,n.length),n)},alignPosition:function(e,t){e&&t&&(e.x=t.x,e.y=t.y)},alignPosRot:function(e,t){e&&t&&(e.x=t.x,e.y=t.y,e.rotation=t.rotation)},toCorner:function(e,t){e&&t&&(e.x=t.x-t.width/2,e.y=t.y-t.height/2)},childTo:function(e,t){return function(n,o){n&&o&&(n.x=o.width*e,n.y=o.height*t)}},aboveCorner:R.curry(function(e,t){return t&&e&&(t.x=e.x-e.width/2,t.y=e.y-e.height/2-t.height),t}),delta:function(e,t){return{x:e.x-t.x,y:e.y-t.y}},shuffle:function(e){for(var t=e.length-1;t>0;t--){var n=Math.floor(Math.random()*(t+1)),o=e[t];e[t]=e[n],e[n]=o}return e},printargs:function(){return arguments[0]},buttonize:function(e,t){return e.interactive=!0,e.buttonMode=!0,e.defaultCursor="pointer",e.click=e.tap=t,e},angle:function(e){return Math.atan2(e.y,e.x)},angle2points:function(e,t){return R.compose(Utils.angle,Utils.delta)(e,t)},rad2Deg:function(e){var t=180*e/Math.PI;return 0>t&&(t+=360),t},addProperties:function(e,t){return R.forEach(function(n){e[n]=t[n]})(R.keys(t)),e},rotate90:function(e){return e+Math.PI/2},removeFromArray:R.curry(function(e,t){return t&&t.length>0&&t.splice(t.indexOf(e),1),e}),removeChildren:function(e){R.times(function(){e.children.length&&e.getChildAt(0)&&e.removeChild(e.getChildAt(0))},e.children.length)},move:function(e){var t,n,o=e.rotation,i=e.speed;return t=Math.cos(o)*i,n=Math.sin(o)*i,e.position.set(e.x+t,e.y+n),e},center:function(e,t){e.x=t.x+(t.width-e.width)/2,e.y=t.y+(t.height-e.height)/2},testHitArray:function(e,t){return function(n){for(var o=t.length-1;o>=0;o-=1)Utils.testHit(n,t[o],e);return n}},testHit:function(e,t,n){Utils.collidesRectCircle(e,t)&&n(e,t)},testNearMissArray:function(e,t){return function(n){for(var o=t.length-1;o>=0;o-=1)Utils.testNearMiss(n,t[o],e);return n}},testNearMiss:function(e,t,n){Utils.collidesRectCircle(e,t,t.nearMissRadius)&&n(t)},pointIntersection:function(e,t){return e.x>t.x&&e.x<t.x+t.width&&e.y>t.y&&e.y<t.y+t.height},simpleIntersection:function(e,t){return!(t.x>e.x+e.width||t.x+t.width<e.x||t.y>e.y+e.height||t.y+t.height<e.y)},getPowDistance:function(e,t,n,o){var i=Math.abs(e-n),r=Math.abs(t-o);return i*i+r*r},collidesRectCircle:function(e,t,n){var o=n||.5*t.width,i=.75*Math.max(e.width,e.height);if(Math.abs(t.x-e.x)<o+i&&Math.abs(t.y-e.y)<o+i){var r,a,s=e.rotation>0?-1*e.rotation:-1*e.rotation+Math.PI,d=Math.cos(s)*(t.x-e.x)-Math.sin(s)*(t.y-e.y)+e.x,c=Math.sin(s)*(t.x-e.x)+Math.cos(s)*(t.y-e.y)+e.y,l=e.x-.5*e.width,u=e.y-.5*e.height;r=l>d?l:d>l+e.width?l+e.width:d,a=u>c?u:c>u+e.height?u+e.height:c;var f=this.getPowDistance(d,c,r,a);if(o*o>f)return!0}return!1},doPolygonsIntersect:function(e,t){var n,o,i,r,a,s,d,c,l=[e,t];for(r=0;r<l.length;r++){var u=l[r];for(a=0;a<u.length;a++){var f=(a+1)%u.length,p=u[a],g=u[f],h={x:g.y-p.y,y:p.x-g.x};for(n=o=void 0,s=0;s<e.length;s++)i=h.x*e[s].x+h.y*e[s].y,(isUndefined(n)||n>i)&&(n=i),(isUndefined(o)||i>o)&&(o=i);for(d=c=void 0,s=0;s<t.length;s++)i=h.x*t[s].x+h.y*t[s].y,(isUndefined(d)||d>i)&&(d=i),(isUndefined(c)||i>c)&&(c=i);if(d>o||n>c)return CONSOLE("polygons don't intersect!"),!1}}return!0}},Video={};Video.existingCalls=[],navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,Video.newPeerServerConnection=function(){Video.peer=new Peer(Network.myId,{key:"8z62zmz8keasjor",debug:1,iceServers:[{url:"stun:stun.l.google.com:19302"}]})},Video.init=function(){$("#video-container").show(),Video.newPeerServerConnection(),Video.peer.on("open",function(e){Video.id=e}),Video.peer.on("call",function(e){e.answer(window.localStream),Video.step3(e)}),Video.peer.on("error",function(e){if(/Could not connect to peer (\w+)/.exec(e.message)){var t=/Could not connect to peer (\w+)/.exec(e.message)[1];Video.step2(t)}else Video.newPeerServerConnection()}),$(function(){$("#step1-retry").click(function(){$("#step1-error").hide(),Video.step1()}),Video.step1()})},Video.newClient=function(e,t){e&&(Video.addVideo(e),$("#"+e).find(".step3").hide(),$("#"+e).find(".make-call").text("Call "+t),$(function(){$("#"+e).find(".make-call").click(function(){var e=$(this).parents("div.video-group").attr("id"),t=Video.peer.call(e,window.localStream);Video.step3(t)}),$("#"+e).find(".end-call").click(function(){$(this).parents("div.video-group").attr("id");Video.existingCalls[e].close(),Video.step2(e)})}),Video.step2(e))},Video.killClient=function(e){Video.removeVideo(e)},Video.addVideo=function(e){$("#their-videos").append('<div class="video-group" id="'+e+'"><div class="step3"><a href="#" class="btn btn-xs btn-danger end-call">x</a></div><video class="video" style="display: none;" autoplay></video><div class="step step2"><a href="#" class="btn btn-xs btn-success make-call">Call</a></div></div>')},Video.removeVideo=function(e){$("#"+e).remove()},Video.step1=function(){$("#step1-error").hide(),navigator.getUserMedia({audio:!0,video:!0},function(e){$("#my-video").prop("src",URL.createObjectURL(e)),$("#my-video").show(),window.localStream=e,$("#step1").hide()},function(){$("#step1-error").show(),$("#my-video").hide()})},Video.step2=function(e){$("#step1").hide(),$("#"+e).find(".step3").hide(),$("#"+e).find(".step2").show()},Video.step3=function(e){Video.existingCalls[e.peer]&&Video.existingCalls[e.peer].close(),e&&(e.on("stream",function(t){$("#"+e.peer).find("video").show(),$("#"+e.peer).find("video").prop("src",URL.createObjectURL(t))}),e.on("close",function(){$("#"+e.peer).find("video").hide(),Video.step2(e.peer)}),e.on("error",function(){$("#"+e.peer).find("video").hide()}),Video.existingCalls[e.peer]=e,$("#step1").hide(),$("#"+e.peer).find(".step2").hide(),$("#"+e.peer).find(".step3").show())};var Screen={},World={width:4e3,height:2e3};Screen.x=window.innerWidth*window.devicePixelRatio,Screen.y=window.innerHeight*window.devicePixelRatio;var game=new Phaser.Game(Screen.x,Screen.y,Phaser.AUTO,"boardgame",{preload:preload,create:Network.setup,update:update}),redDice,blueDice,cards1,stacks,tokens,players,table,playerList={},player={},stack1,stack2,chatInput;